name: Pull Request

on:
    pull_request_target:
    workflow_dispatch:

concurrency:
    group: ${{ github.repository }}-${{ github.event.pull_request.number }}-pullRequest
    cancel-in-progress: true

permissions:
    contents: write
    pull-requests: write

jobs:
    GitStatusCheck:
        name: GitStatusCheck
        runs-on: ubuntu-latest
        outputs:
            shouldRun: ${{ steps.GitStatusCheck.outputs.shouldRun }}
        steps:
            -   name: GitStatusCheck
                id: GitStatusCheck
                uses: EncoreDigitalGroup/ci-workflows/actions/php/gitStatusCheck@v2

    FormatTitle:
        name: FormatTitle
        runs-on: ubuntu-latest
        steps:
            -   name: FormatTitle
                uses: EncoreDigitalGroup/ci-workflows/actions/github/formatPullRequestTitle@v2
                with:
                    branch: ${{ github.head_ref }}
                    pullRequestNumber: ${{ github.event.number }}
                    repository: ${{ github.repository }}
                    token: ${{ secrets.GITHUB_TOKEN }}

    CodeStyle:
        needs: GitStatusCheck
        name: CodeStyle
        if: needs.GitStatusCheck.outputs.shouldRun == 'true'
        runs-on: ubuntu-latest
        steps:
            -   name: CodeStyle
                uses: EncoreSoftware/ci-pipelines/actions/php/codeStyle@v2
                with:
                    branch: "${{ github.head_ref }}"
                    repository: "${{ github.repository }}"
                    composerAuthJson: "${{ vars.COMPOSER_AUTH_JSON }}"

    StaticAnalysis:
        needs: CodeStyle
        name: StaticAnalysis
        uses: EncoreSoftware/ci-pipelines/.github/workflows/php_staticAnalysis.yml@v2
        with:
            composerAuthJson: ${{ vars.COMPOSER_AUTH_JSON }}
            phpVersion: '8.3'
            path: 'src/'
            branch: ${{ github.head_ref }}

    AutoMerge:
        needs: [ StaticAnalysis ]
        name: Auto-Merge
        uses: EncoreDigitalGroup/ci-workflows/.github/workflows/github_dependabotAutoMerge.yml@v2